<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled</title>
    <meta name="description" content="Untitled - Hongwei Zhao's Blog">
    <meta name="author" content="Hongwei Zhao">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-theme-dark">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme-light" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        :root {
            /* Light Theme - 明亮清新配色 */
            --primary-color: #4A90D9;
            --primary-hover: #3678C2;
            --link-color: #E86B5F;
            --text-color: #2D2D2D;
            --text-light: #5A5A5A;
            --text-muted: #8A8A8A;
            --bg-color: #FFFFFF;
            --bg-secondary: #F5F7FA;
            --bg-code: #F8F9FC;
            --border-color: #E8ECF0;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary-color: #5dade2;
            --primary-hover: #85c1e9;
            --link-color: #e74c3c;
            --text-color: #e5e7eb;
            --text-light: #9ca3af;
            --text-muted: #6b7280;
            --bg-color: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-code: #0f0f23;
            --border-color: #374151;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-lg: 0 4px 15px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-color);
            background: var(--bg-color);
            transition: background-color 0.3s, color 0.3s;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Layout */
        .page-wrapper {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            gap: 3rem;
        }

        /* Sidebar TOC */
        .toc-sidebar {
            width: 260px;
            flex-shrink: 0;
            position: sticky;
            top: 2rem;
            height: fit-content;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .toc-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .toc-container h3 {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toc-container ul {
            list-style: none;
        }

        .toc-container li {
            margin-bottom: 0.5rem;
        }

        .toc-container a {
            font-size: 0.9rem;
            color: var(--text-light);
            display: block;
            padding: 0.25rem 0;
            border-left: 2px solid transparent;
            padding-left: 0.75rem;
            transition: all 0.2s;
        }

        .toc-container a:hover,
        .toc-container a.active {
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            text-decoration: none;
        }

        .toc-container ul ul {
            margin-left: 1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            min-width: 0;
            max-width: 800px;
        }

        /* Header */
        .post-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .back-link:hover {
            color: var(--primary-color);
            text-decoration: none;
        }

        .post-header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .post-meta span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .post-meta i {
            color: var(--text-muted);
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tag {
            display: inline-block;
            font-size: 0.8rem;
            background: var(--bg-secondary);
            color: var(--text-light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .tag:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Article Content */
        .post-content {
            font-size: 1rem;
            line-height: 1.9;
        }

        .post-content h1,
        .post-content h2,
        .post-content h3,
        .post-content h4,
        .post-content h5,
        .post-content h6 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-color);
        }

        .post-content h1 { font-size: 1.875rem; }
        .post-content h2 { 
            font-size: 1.5rem; 
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .post-content h3 { font-size: 1.25rem; }
        .post-content h4 { font-size: 1.125rem; }

        .post-content p {
            margin-bottom: 1.25rem;
        }

        .post-content ul,
        .post-content ol {
            margin: 1.25rem 0;
            padding-left: 1.5rem;
        }

        .post-content li {
            margin-bottom: 0.5rem;
        }

        .post-content blockquote {
            margin: 1.5rem 0;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary-color);
            border-radius: 0 8px 8px 0;
            color: var(--text-light);
            font-style: italic;
        }

        .post-content blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Code */
        .post-content code {
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 0.9em;
            background: var(--bg-code);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            color: var(--link-color);
        }

        .post-content pre {
            margin: 1.5rem 0;
            padding: 1.25rem;
            background: var(--bg-code);
            border-radius: 10px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .post-content pre code {
            background: none;
            padding: 0;
            color: inherit;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        /* Images */
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 1.5rem 0;
            box-shadow: var(--shadow-lg);
        }

        /* Tables */
        .post-content table {
            width: 100%;
            margin: 1.5rem 0;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .post-content th,
        .post-content td {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .post-content th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .post-content tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        /* Math */
        .math-display {
            margin: 1.5rem 0;
            overflow-x: auto;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        /* Anchor links */
        .anchor-link {
            opacity: 0;
            margin-left: 0.5rem;
            color: var(--text-muted);
            font-weight: 400;
            transition: opacity 0.2s;
        }

        .post-content h2:hover .anchor-link,
        .post-content h3:hover .anchor-link,
        .post-content h4:hover .anchor-link {
            opacity: 1;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-lg);
            transition: transform 0.2s, background 0.2s;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-hover);
        }

        /* Comments Section */
        .comments-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .comments-section h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Footer */
        .post-footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .toc-sidebar {
                display: none;
            }
            
            .page-wrapper {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .post-header h1 {
                font-size: 1.75rem;
            }
            
            .post-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .theme-toggle {
                bottom: 1rem;
                right: 1rem;
                width: 44px;
                height: 44px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- TOC Sidebar -->
        <aside class="toc-sidebar">
            <div class="toc-container">
                <h3><i class="fas fa-list"></i> 目录</h3>
                <div class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#proposed-method">Proposed Method</a></li>
<li><a href="#preliminary">Preliminary</a></li>
<li><a href="#problem-setup">Problem Setup</a></li>
<li><a href="#robust-adapter-r-adapter">Robust Adapter (R-Adapter)</a></li>
<li><a href="#mpm-nce-loss-for-downstream-task">MPM-NCE Loss for Downstream Task</a></li>
<li><a href="#experiments">Experiments</a></li>
</ul>
</div>

            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <article>
                <header class="post-header">
                    <a href="../../../../index.html" class="back-link">
                        <i class="fas fa-arrow-left"></i> 返回博客列表
                    </a>
                    <h1>Untitled</h1>
                    <div class="post-meta">
                        <span><i class="fas fa-calendar-alt"></i> 2026-02-04</span>
                        <span><i class="fas fa-folder"></i> AINotes/14.PEFT/05.Adapter</span>
                        <span><i class="fas fa-user"></i> Hongwei Zhao</span>
                    </div>
                    <div class="tags">
                        
                    </div>
                </header>

                <div class="post-content">
                    <blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/718589490">R-Adapter：零样本模型微调新突破，提升鲁棒性与泛化能力 | ECCV 2024</a></p>
<p>大规模图像-文本预训练模型实现了零样本分类，并在不同数据分布下提供了一致的准确性。然而，这些模型在下游任务中通常需要微调优化，这会降低对于超出分布范围的数据的泛化能力，并需要大量的计算资源。论文提出新颖的<code>Robust Adapter</code>（<code>R-Adapter</code>），可以在微调零样本模型用于下游任务的同时解决这两个问题。该方法将轻量级模块集成到预训练模型中，并采用新颖的自我集成技术以提高超出分布范围的鲁棒性，并大幅减少存储开销。此外，论文提出了针对视觉-语言下游任务设计的<code>MPM-NCE</code>损失，确保多个图像-文本对的精确对齐和具有区分性的特征学习。<br />
来源：晓飞的算法工程笔记 公众号</p>
</blockquote>
<p><strong>论文: Efficient and Versatile Robust Fine-Tuning of Zero-shot Models</strong></p>
<p><img alt="" src="(20240906)R-Adapter零样本模型微调新突破提升鲁棒性与泛化能力__ECCV_2024_VincentLee/v2-d8294ca6898613217a8017861d3dbc08_1440w.jpg" />  </p>
<ul>
<li><strong>论文地址：<a href="https://www.arxiv.org/abs/2408.05749"><span class="invisible">https://www.</span></a></strong></li>
<li><strong>论文代码：<a href="http://cvlab.postech.ac.kr/research/R-Adapter"><span class="invisible">http://</span></a></strong></li>
</ul>
<h2 id="introduction">Introduction<a class="anchor-link" href="#introduction" title="Permanent link">&para;</a></h2>
<hr />
<p>大规模联合图像和文本数据预训练模型的出现在计算机视觉领域引起了范式转变。通过对大量图像-文本对的嵌入进行对齐，这些模型实现了零样本推断，并展现出在不同数据分布下广泛泛化的显著能力。尽管它们在零样本情境下表现出色，但它们无法与监督学习模型相媲美，需要进行微调以发挥其全部能力。然而，传统的全面微调会产生两个主要挑战：<code>1</code>）全面微调损害了模型对于超出分布范围（<code>OOD</code>）数据的泛化能力，而这对于数据变异性不可预测的实际应用至关重要。<code>2</code>）它需要大量的计算资源、内存和存储，而随着大规模预训练模型的不断增大，这是不切实际的。</p>
<p><img alt="" src="(20240906)R-Adapter零样本模型微调新突破提升鲁棒性与泛化能力__ECCV_2024_VincentLee/v2-18bf8c152120661214718b6d9cadd761_1440w.jpg" />  </p>
<p>最近，针对这些挑战提出了几种微调方法。鲁棒微调的目标是在微调零样本模型的同时保持对<code>OOD</code>的鲁棒性，而参数高效微调（<code>PEFT</code>）仅更新一小部分参数，同时保持预训练参数的冻结状态。然而，每种方法只解决其中一个挑战，同时在另一个挑战上仍然存在不足。如图<code>1</code>所示，现有的鲁棒微调方法仍然需要微调整个模型，导致训练代价高昂。此外，它们仅针对分类任务，因此通常仅训练图像编码器，从模型中排除了零样本推断能力。另一方面，与鲁棒微调相比，<code>PEFT</code>在分布偏移下的性能显著滞后。它们的关键缺点凸显了需要新的微调方法，同时解决鲁棒微调和<code>PEFT</code>分别应对的两个挑战。</p>
<p>本文提出了一种名为鲁棒适配器（<code>R-Adapter</code>）的新型微调方法，旨在提高<code>PEFT</code>的鲁棒性，并增强鲁棒微调的效率。在适配器微调方法的基础上向预训练模型添加额外的轻量级模块，<code>R-Adapter</code>引入了新颖的自我集成策略，以增强<code>OOD</code>的鲁棒性。</p>
<p>受到在权重空间中平均多个模型时观察到的鲁棒性增益的启发，通过一种独特的方式在单个模型内实现这种策略。这种方法在任务特定性能和针对分布偏移的鲁棒性之间取得了良好的平衡，同时显著降低了存储成本。具体而言，<code>R-Adapter</code>通过三种自我集成技术实现这一目标。它随机丢弃适配器模块，从而动态生成并集成不同子网络，以各种配置组合适配器和预训练层。此外，累积适配器权重以形成一个时间集成，捕捉整个学习过程中产生的所有模型。此外，通过重新缩放适配器的权重，并通过重新参数化将其整合到预训练层中，论文实现了在没有两个单独模型的情况下，在预训练和微调模型的权重之间实现无缝的线性插值。</p>
<p>此外，论文提出了一种名为<code>Multi-Positive Margin NCE</code>（<code>MPM-NCE</code>）损失函数，专为在视觉-语言下游任务上进行有效微调而设计。这些任务通常涉及复杂的关系，其中多个图像可以对应于相同的文本，反之亦然。与传统的对比损失（例如<code>InfoNCE</code>）不同，后者接受单一正样本对，并因此经常导致这些关系中的语义不匹配，<code>MPM-NCE</code>考虑了多个正样本对，从而更精确地对齐跨各种图像和文本对。此外，<code>MPM-NCE</code>引入了一个角度边距以惩罚负样本对，使模型能够学习对下游任务至关重要的高度区分的特征。因此，所提出的损失函数显著改善了任务特定性能，在<code>ID</code>和<code>OOD</code>环境下都带来了益处。</p>
<p>论文的方法在微调后实现了零样本推理，在图像分类任务之外扩展了其适用性范围，适用于广泛的应用领域。为了展示其多功能性，论文提出了一个新的用于鲁棒微调的评估基准，包括五个任务：三种情景下的图像分类任务、跨模态检索和开放词汇分割。大量实验证明，与现有的鲁棒微调和<code>PEFT</code>方法相比，论文的方法在分布转移条件下表现出卓越性能，同时使用的参数更少。</p>
<p>本文的主要贡献有四点：</p>
<ol>
<li>提出了一个高效且多功能的鲁棒微调框架，融合了<code>PEFT</code>和鲁棒微调的优势，这是第一个兼具两者优势的方法。</li>
<li>提出了<code>R-Adapter</code>，采用自集成技术，借助单个带有适配器的模型实现权重空间集成。能够在减少存储成本的同时增强鲁棒性，因为不需要多个模型。</li>
<li>开发了适用于微调的<code>MPM-NCE</code>损失，利用多个正样本对和引入角度间隔，确保了多个图像-文本对的精确对齐和具有区分性的特征学习。</li>
<li>首次将鲁棒微调的基准拓展到图像分类之外的任务，包括跨模态检索和开放词汇分割，从而允许评估其广泛适用性。论文的方法在各种任务中取得了最先进的性能，仅微调了<code>13%</code>的<code>CLIP</code>编码器参数。</li>
</ol>
<h2 id="proposed-method">Proposed Method<a class="anchor-link" href="#proposed-method" title="Permanent link">&para;</a></h2>
<hr />
<h2 id="preliminary">Preliminary<a class="anchor-link" href="#preliminary" title="Permanent link">&para;</a></h2>
<ul>
<li>CLIP Encoders</li>
</ul>
<p><code>CLIP</code>由两个编码器组成，分别用于从图像和文本中提取特征。每个编码器由一系列<code>Transformer</code>层组成，每个层包括多头注意力（<code>MHA</code>）、层归一化（<code>LN</code>）和前馈神经网络（<code>FFN</code>）。具体而言，第 <span class="math-inline">l</span> 层<code>Transformer</code>层的公式如下：</p>
<p><div class="math-display">\begin{equation} \begin{aligned} \bar{X_l} &amp;= \textrm{MHA}(\textrm{LN}(X_{l-1})) + X_{l-1}, \ X_l &amp;= \textrm{FFN}(\textrm{LN}(\bar{X_l})) + \bar{X_l}.  \end{aligned} \end{equation} \</div></p>
<p><code>MHA</code>包括对查询、键和值进行 <span class="math-inline">k</span> 头自注意力操作，通过对输入进行独立的线性投影来实现，其公式为:</p>
<p><div class="math-display">\begin{equation} \begin{aligned} \textrm{MHA}(X) &amp;= [\textrm{Attn}^1(X), ..., \textrm{Attn}^k(X)]W_O,\ \textrm{Attn}^i(X) &amp;= \textrm{softmax}\big((XW_{Q}^{i})(XW_{K}^{i})^{\top}/{\sqrt{d_h}} \big)(XW_{V}^{i}),  \end{aligned} \end{equation} \</div></p>
<p>其中 <span class="math-inline">[\cdot,\cdot]</span> 表示拼接， <span class="math-inline">d_h</span> 设为 <span class="math-inline">d/k</span> 。 <span class="math-inline">W_{Q}^{i}\in\mathbb{R}^{d\times d_h}</span> ， <span class="math-inline">W_{K}^{i}\in\mathbb{R}^{d\times d_h}</span> ， <span class="math-inline">W_{V}^{i}\in\mathbb{R}^{d\times d_h}</span> 和 <span class="math-inline">W_{O}\in\mathbb{R}^{d\times d}</span> 是线性投影矩阵。<code>FFN</code>由两个线性层和一个非线性层组成：</p>
<p><div class="math-display">\begin{equation} \textrm{FFN}(X) = \sigma(XW_1+b_1)W_2 + b_2, \label{eq:FFN} \end{equation} \</div></p>
<p>其中 <span class="math-inline">W_1\in\mathbb{R}^{d\times4d}</span> , <span class="math-inline">W_2\in\mathbb{R}^{4d\times d}</span> , <span class="math-inline">b_1 \in \mathbb{R}^{4d}</span> , 和 <span class="math-inline">b_2 \in \mathbb{R}^d</span> 分别是线性投影的权重和偏置； <span class="math-inline">\sigma(\cdot)</span> 表示<code>GELU</code>函数。</p>
<ul>
<li>Contrastive Learning</li>
</ul>
<p><code>CLIP</code>编码器被训练用于预测哪些文本描述与给定的一组图像匹配，反之亦然。这通过使用<code>InfoNCE</code>损失来进行对比学习来实现，该损失迫使图像嵌入和其对应的文本嵌入彼此靠近，并远离批次中的其他文本嵌入。设 <span class="math-inline">f(\cdot)</span> 和 <span class="math-inline">g(\cdot)</span> 分别是图像和文本的<code>CLIP</code>编码器。给定一个批次包含 <span class="math-inline">B</span> 个图像-文本对 <span class="math-inline">\mathcal{B} =\big{(I_1,T_1), ..., (I_B,T_B)\big}</span> ，损失函数定义为:</p>
<p><div class="math-display">\begin{equation} \begin{aligned} \mathcal{L}(\mathcal{B}) = &amp;-\sum_{i=1}^{B}\Bigg(\log\frac{e^{f_i \cdot g_i/\tau }}{\sum_{j=1}^{B}e^{f_i \cdot g_j/\tau }} +\log\frac{e^{f_i\cdot g_i/\tau }}{\sum_{j=1}^{B}e^{f_j\cdot g_i/\tau}}\Bigg),  \end{aligned} \end{equation} \</div></p>
<p>其中 <span class="math-inline">f_i = \frac{f(I_i)}{||f(I_i)||_2}</span> , <span class="math-inline">g_i = \frac{g(T_i)}{||g(T_i)||_2}</span> ， <span class="math-inline">\tau</span> 表示一个可学习的温度参数。</p>
<h2 id="problem-setup">Problem Setup<a class="anchor-link" href="#problem-setup" title="Permanent link">&para;</a></h2>
<p>论文的目标是在保留其固有的离群分布泛化能力的同时，高效地对视觉-语言预训练模型进行各种下游任务的微调。虽然大多数现有的鲁棒微调方法局限于分类任务，但论文将范围扩大到为各种下游任务，如图像分类、跨模态检索和开放词汇分割等，提供鲁棒微调模型。</p>
<p>给定一个图像-文本预训练模型，目标是使用一个面向目标下游任务的内分布（<code>ID</code>）训练数据集 <span class="math-inline">\mathcal{D}<em>{\mathcal{I}}={(I_i, T_i)}</em>{i=1}^{n}</span> 对其进行适应，其中 <span class="math-inline">I</span> 表示一个图像， <span class="math-inline">T</span> 是对应于该图像的文本描述。同时，旨在提高模型在一个离群分布（<code>OOD</code>）测试数据集 <span class="math-inline">\mathcal{D}<em>{\mathcal{O}}={(I_j, T_j)}</em>{j=1}^{m}</span> 上的性能。内分布和离群分布数据集 <span class="math-inline">\mathcal{D}<em>{\mathcal{I}}</span> 和 <span class="math-inline">\mathcal{D}</em>{\mathcal{O}}</span> 分别从不同概率分布 <span class="math-inline">p_{\mathcal{I}}(I,T)</span> 和 <span class="math-inline">p_{\mathcal{O}}(I,T)</span> 中采样，当 <span class="math-inline">p_{\mathcal{I}}(I,T)\neq p_{\mathcal{O}}(I,T)</span> 时即为表现出分布转移。在分类任务中， <span class="math-inline">T</span> 表示目标类的文本描述，通过从一组预定义模板中进行采样构建（例如，“一张{<code>class</code>}的照片”）。对于其他视觉-语言任务， <span class="math-inline">T</span> 可能是与图像 <span class="math-inline">I</span> 相关联的标题之一。</p>
<h2 id="robust-adapter-r-adapter">Robust Adapter (R-Adapter)<a class="anchor-link" href="#robust-adapter-r-adapter" title="Permanent link">&para;</a></h2>
<p>为了实现高效且鲁棒的微调，论文引入了基于<code>PEFT</code>框架的<code>R-Adapter</code>。<code>PEFT</code>框架在微调少量附加的可学习参数的同时冻结预训练模型，但在训练中对该框架的朴素应用可能会导致对内分布数据的显著偏向（参见表<code>2</code>）。受到集成增强在各种分布下的泛化能力的启发，<code>R-Adapter</code>设计了三种新颖的自集成策略，以实现鲁棒微调而不在训练和推理期间增加计算负载。</p>
<ul>
<li>Design of R-Adapter</li>
</ul>
<p><code>R-Adapter</code>建立在适配器微调框架之上，在该框架中向预训练模型添加了轻量级模块。具体而言，<code>R-Adapter</code>中的适配器模块采用了<code>Houlsby</code>适配器的简化版本，去除了非线性层和偏置。该模块被构建为一个残差块，由以下权重矩阵组成：</p>
<p><div class="math-display">\begin{equation} h(X) = XW_{\textrm{adp}} + X,  \end{equation} \</div></p>
<p>其中， <span class="math-inline">X</span> 表示预训练块的输出， <span class="math-inline">W_{\textrm{adp}} \in \mathbb{R}^{d\times d}</span> 是论文适配器的权重矩阵。对于全样本学习，保持 <span class="math-inline">W_{\textrm{adp}}</span> 的满秩结构以保留足够的容量。在少样本学习中，可以通过将 <span class="math-inline">W_{\textrm{adp}}</span> 分解为低秩矩阵 <span class="math-inline">BA</span> 的乘积来采用瓶颈结构，其中 <span class="math-inline">B\in \mathbb{R}^{d\times r}</span> ， <span class="math-inline">A\in \mathbb{R}^{r\times d}</span> ，且秩 <span class="math-inline">r \ll d</span> 。这种分解避免了过参数化，并显著减少了参数数目和计算量。</p>
<p><img alt="" src="(20240906)R-Adapter零样本模型微调新突破提升鲁棒性与泛化能力__ECCV_2024_VincentLee/v2-e86568e8db5e8f132317d02e91625e64_1440w.jpg" />  </p>
<p>在图像和文本编码器的每个<code>Transformer</code>层中部署适配器，放置在<code>MHA</code>（<code>Multi-Head Attention</code>）和<code>FFN</code>（<code>Feed-Forward Network</code>）层之后，如图<code>2</code>所示。</p>
<p>由于适配器之前没有非线性结构，可以通过将其与最接近的预训练层集成进行重参数化，从而在推理过程中消除适配器的额外计算开销。用 <span class="math-inline">W_{\textrm{org}}</span> 表示适配器之前的预训练层的权重，可以是来自<code>MHA</code>的 <span class="math-inline">W_O</span> 或者<code>FFN</code>中的 <span class="math-inline">W_2</span> ，相应的偏置 <span class="math-inline">b_{\textrm{org}}</span> 是<code>FFN</code>中的 <span class="math-inline">b_2</span> 。给定预训练层的输入 <span class="math-inline">X_{\textrm{in}}</span> ，那么重新参数化的过程如下进行：</p>
<p><div class="math-display">\begin{align} \begin{aligned} h(X_\textrm{in}W_\textrm{org} + b_\textrm{org}) &amp;= X_\textrm{in}W_\textrm{org}(W_{\textrm{adp}} + \mathrm{I})  + b_{\textrm{org}}W_{\textrm{adp}} + b_{\textrm{org}} \ &amp;= X_\textrm{in}W_\textrm{rep} + b_\textrm{rep},  \end{aligned} \end{align} \</div></p>
<p>其中， <span class="math-inline">\mathrm{I}\in\mathbb{R}^{d\times d}</span> 是单位矩阵， <span class="math-inline">W_\textrm{rep} = W_\textrm{org}(W_\textrm{adp}+\mathrm{I})</span> ， <span class="math-inline">b_\textrm{rep} = b_\textrm{org}(W_\textrm{adp}+\mathrm{I})</span> 。</p>
<ul>
<li>Dynamic Ensemble by Adapter Dropping</li>
</ul>
<p>为了增强<code>R-Adapter</code>的<code>OOD</code>鲁棒性，加入适配器丢弃的动态集成技术。在训练过程中，适配器模块以以下方式被随机停用：</p>
<p><div class="math-display">\begin{equation} h(X) = \frac{\gamma}{1-p} \cdot XW_{\textrm{adp}} + X,  \end{equation} \</div></p>
<p>其中， <span class="math-inline">\gamma</span> 是从 <span class="math-inline">\textrm{Bernoulli}(1-p)</span> 中抽取的独立变量， <span class="math-inline">p</span> 是适配器丢弃的概率。</p>
<p>与用于特征稀疏性的<code>dropout</code>或用于模型深度减少的<code>drop-path</code>不同，该技术独特地专注于在保持预训练特征的同时随机禁用适配器层。适配器丢弃不适用于推理阶段，这样可以创建一个由预训练层和适配器层组合而成的子网络集合。这种策略能够同时保留预训练知识和微调知识的动态集成多模型，从而在<code>ID</code>和<code>OOD</code>数据上提升性能。</p>
<ul>
<li>Temporal Ensemble by Accumulation</li>
</ul>
<p>通过利用适配器权重的历史累积，引入一个时间集成策略来提高模型的鲁棒性。在训练过程中，通过对多次迭代中的权重进行平均，集成技术捕捉到对特征空间的更广泛了解。累积适配器的权重 <span class="math-inline">\tilde{W}_\textrm{adp}</span> 则通过指数移动平均进行更新：</p>
<p><div class="math-display">\begin{equation} \tilde{W}<em>\textrm{adp} \leftarrow m \cdot \tilde{W}</em>\textrm{adp} + (1-m) \cdot {W}_\textrm{adp},  \end{equation} \</div></p>
<p>其中， <span class="math-inline">m \in [0, 1]</span> 是控制动量更新速率的系数。这种方法在内存使用方面非常高效，因为只有适配器的参数进行了动量更新，而不是整个模型的参数。在推理阶段，利用累积的权重 <span class="math-inline">\tilde{W}<em>\textrm{adp}</span> 来计算重参数化权重 <span class="math-inline">\tilde{W}</em>\textrm{rep}</span> 和偏置 <span class="math-inline">\tilde{b}_\textrm{rep}</span> 。</p>
<ul>
<li>Weight-space Ensemble by Re-scaling</li>
</ul>
<p>最后，引入一种通过重新调整参数实现预训练层和微调层之间的权重空间集成的策略。传统的权重空间集成（<code>WiSE-FT</code>）在原始预训练参数和微调参数之间进行线性插值，因此需要存储两个独立的模型。相比之下，论文采用重参数化的权重 <span class="math-inline">\tilde{W}_\textrm{rep}</span> 作为微调层的权重，从而进化了这个概念。我们在推理时重新调整适配器的权重并对其重参数化，将权重空间集成简化为单一模型内的实现。该过程可以表达如下：</p>
<p><div class="math-display">\begin{align} \begin{aligned} \underbrace{\alpha \tilde{W}<em>\textrm{rep} + (1-\alpha) W</em>\textrm{org}}<em>\texttt{{{{Weight-space Ensemble}}}} &amp;= \alpha W</em>\textrm{org}\tilde{W}<em>\textrm{adp}  + \alpha W</em>\textrm{org} + (1-\alpha) W_\textrm{org} \[-17pt] &amp;= \underbrace{W_\textrm{org}(\overbrace{\alpha \tilde{W}<em>\textrm{adp}}^\texttt{{{{Re-scaling}}}} \;+\; \mathrm{I}) = W</em>\textrm{ens}}_\texttt{{{Re-parametrization}}}, \  \end{aligned} \end{align} \</div></p>
<p>这里， <span class="math-inline">W_\textrm{ens}</span> 表示集成的权重， <span class="math-inline">\alpha</span> 是一个重调整系数。系数 <span class="math-inline">\alpha</span> 充当插值因子，调整原始预训练权重 <span class="math-inline">W_\textrm{org}</span> 与微调层调整权重之间的平衡。这种技术不仅可以提高在分布转移下的准确性，也能在<code>ID</code>数据上保持高性能。关键是，与<code>WiSE-FT</code>不同，该方法不需要在存储中维护两个单独的完整模型，因此更有效地促进了更节省存储空间的权重空间集成。</p>
<h2 id="mpm-nce-loss-for-downstream-task">MPM-NCE Loss for Downstream Task<a class="anchor-link" href="#mpm-nce-loss-for-downstream-task" title="Permanent link">&para;</a></h2>
<p>为了增强下游任务的学习能力，使用与任务特征密切对齐的损失函数至关重要。视觉-语言任务通常涉及多个模态之间的对应关系。例如，在分类任务中，对同一类别使用不同的文本模板可能导致多个文本描述与单个图像匹配，反之亦然。这种情况在涉及图像和标题的跨模态检索任务中也会发生。当将零样本模型调整到新任务时，一种常见方法是使用预训练中使用的<code>InfoNCE</code>损失。然而，对于存在多个正样本的任务，该损失并不理想，因为它只考虑了单个正样本对。此外，<code>InfoNCE</code>学习了正负样本之间的顺序，这可能不会为下游任务产生足够有区分力的特征。</p>
<p>为了解决这些限制，论文提出了<code>MPM-NCE</code>损失，旨在适应这些任务的多正样本性质，同时增强所学嵌入的区分能力。这个损失函数有两个关键改进。首先，使用软标签为多个正样本对分配相等的概率，公式如下：</p>
<p><div class="math-display">\begin{equation} \tilde{y}<em>{ij} = \frac{(1-\epsilon)\cdot y</em>{ij}}{|P(i)|} + \frac{\epsilon \cdot (1-y_{ij})}{B-|P(i)|} \in [0,1], \end{equation} \</div></p>
<p>其中 <span class="math-inline">y_{ij} \in {0,1}</span> 表示样本 <span class="math-inline">i</span> 和 <span class="math-inline">j</span> 之间的正关系， <span class="math-inline">P(i)</span> 是包括自身在内的样本 <span class="math-inline">i</span> 的正样本集合， <span class="math-inline">\epsilon</span> 是一种平滑标签噪声。这种软标签确保在下游任务中正确对齐多个图像-文本对。此外，软标签还可以包含 <span class="math-inline">\epsilon</span> ，通过对标签引入小的扰动来降低过拟合风险。</p>
<p>第二个改进是对负样本对应用边界 <span class="math-inline">\delta</span> 。这个边界通过确保负样本对不仅是不同的，而且还要被一定的阈值分开，增强了所学特征的区分度。融合了这些改进，<code>MPM-NCE</code>公式如下：</p>
<p><div class="math-display">\begin{equation} \mathcal{L}(\mathcal{B}) = -\sum_{i,j=1}^{B}\Bigg(\tilde{y}<em>{ij}\log\frac{e^{(f_i \cdot g_j+\delta</em>{ij})/\tau }}{\sum_{k=1}^{B}e^{(f_i \cdot g_k + \delta_{ik})/\tau}} +\tilde{y}<em>{ji}\log\frac{e^{ (f_j \cdot g_i+\delta</em>{ji})/\tau}}{\sum_{k=1}^{B}e^{(f_k \cdot g_i + \delta_{ki})/\tau}}\Bigg), \end{equation} \</div></p>
<p>其中温度 <span class="math-inline">\tau</span> 被设为常数值<code>0.01</code>， <span class="math-inline">\delta_{ij}</span> 对于正关系为<code>0</code>，对于其他情况为 <span class="math-inline">\delta</span> 。因此，<code>MPM-NCE</code>损失鼓励模型正确对齐多个图像-文本对，并学习具有区分度的特征，从而在<code>ID</code>和<code>OOD</code>下显著提高性能。</p>
<h2 id="experiments">Experiments<a class="anchor-link" href="#experiments" title="Permanent link">&para;</a></h2>
                </div>

                <!-- Comments Section (Giscus) -->
                <section class="comments-section">
                    <h3><i class="fas fa-comments"></i> 评论</h3>
                    <script src="https://giscus.app/client.js"
                        data-repo="Geeks-Z/Geeks-Z.github.io"
                        data-repo-id=""
                        data-category="Announcements"
                        data-category-id=""
                        data-mapping="pathname"
                        data-strict="0"
                        data-reactions-enabled="1"
                        data-emit-metadata="0"
                        data-input-position="bottom"
                        data-theme="preferred_color_scheme"
                        data-lang="zh-CN"
                        crossorigin="anonymous"
                        async>
                    </script>
                </section>
            </article>

            <footer class="post-footer">
                <p>© 2025 Hongwei Zhao. Built with ❤️</p>
            </footer>
        </main>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const icon = themeToggle.querySelector('i');
        const hljsDark = document.getElementById('hljs-theme-dark');
        const hljsLight = document.getElementById('hljs-theme-light');
        
        // Check saved theme or system preference
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            html.setAttribute('data-theme', 'dark');
            icon.className = 'fas fa-sun';
            hljsDark.disabled = false;
            hljsLight.disabled = true;
        }
        
        themeToggle.addEventListener('click', () => {
            const isDark = html.getAttribute('data-theme') === 'dark';
            if (isDark) {
                html.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
                hljsDark.disabled = true;
                hljsLight.disabled = false;
            } else {
                html.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
                hljsDark.disabled = false;
                hljsLight.disabled = true;
            }
            
            // Update Giscus theme
            const giscusFrame = document.querySelector('iframe.giscus-frame');
            if (giscusFrame) {
                giscusFrame.contentWindow.postMessage({
                    giscus: {
                        setConfig: {
                            theme: isDark ? 'light' : 'dark'
                        }
                    }
                }, 'https://giscus.app');
            }
        });
        
        // Highlight.js
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
        });
        
        // KaTeX auto-render
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false
                });
            }
        });
        
        // TOC active state
        const tocLinks = document.querySelectorAll('.toc-container a');
        const headings = document.querySelectorAll('.post-content h2, .post-content h3, .post-content h4');
        
        function updateTocActive() {
            let current = '';
            headings.forEach(heading => {
                const rect = heading.getBoundingClientRect();
                if (rect.top <= 100) {
                    current = heading.getAttribute('id');
                }
            });
            
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }
        
        window.addEventListener('scroll', updateTocActive);
        updateTocActive();
    </script>
</body>
</html>
